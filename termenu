#!/usr/bin/env python
import re
import sys
import termenu

def main():
    redirectedStdin, redirectedStdout = termenu.redirect_std()
    from optparse import OptionParser, IndentedHelpFormatter
    class MyHelpFormatter(IndentedHelpFormatter):
        def format_description(self, description):
            return description

    description = """\
Shows an inline interactive menu. Menu items can be supplied as arguments,
via STDIN (if no arguments were given) or a file (using -f).

Examples:
    termenu Abort Retry Fail
    ls | termenu
    termenu.py -f file_with_options.txt
"""
    parser = OptionParser(usage="Usage: %prog [items]", description=description, formatter=MyHelpFormatter(), add_help_option=False)
    parser.add_option("--help", help="Show help message", action="store_true", default=False)
    parser.add_option("-f", "--file", help="Take menu items from a file", metavar="FILE")
#~     parser.add_option("-t", "--title", help="A title for the menu", default="")
    parser.add_option("-d", "--default", help="Default item to select", metavar="OPTION")
    parser.add_option("-h", "--height", type="int", help="Max height [10]", metavar="N", default=10)
    parser.add_option("-o", "--one", action="store_true", help="Don't show a menu if only one option was given [False]")
    parser.add_option("-p", "--precolored", action="store_true", help="Work better with ANSI colored options [False]")
    parser.add_option("--no-multi", dest="multiselect", action="store_false", default=True, help="Allow multiple selection via <Space> key")
    (options, args) = parser.parse_args()

    if options.help:
        parser.print_help()
        sys.exit(255)

    items = []

    try:
        if options.file:
            items = open(options.file).readlines()
        elif len(args) > 0:
            items = args
        else:
            items = redirectedStdin.readlines()
    except IOError, e:
        parser.error(str(e))

    if not items:
        parser.error("no menu items provided")

    items = [re.sub("\s+", " ", item.strip()) for item in items]
    plugins = [termenu.FilterPlugin()]

    if options.precolored:
        plugins.append(termenu.Precolored())

    if options.one and len(items) == 1:
        results = [items[0]]
    else:
        results = termenu.Termenu(items,
            default=options.default,
            height=options.height,
            multiselect=options.multiselect,
            plugins=plugins).show()

    if results:
        redirectedStdout.write("\n".join(results) + "\n")

if __name__ == "__main__":
    main()
